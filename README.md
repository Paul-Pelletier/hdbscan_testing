# Geometry-Driven Regime Discovery on Synthetic IV Surfaces

## Overview
This project demonstrates a rigorous, geometry-first approach to regime discovery in synthetic implied volatility (IV) surfaces, using tools from rough path theory, unsupervised learning, and market-consistent modeling. The pipeline is designed to answer: **Can geometric signatures and clustering recover economically meaningful volatility regimes from realistic, arbitrage-free surfaces?**

## Pipeline Summary
1. **Synthetic IV Surface Generation (Market-Consistent SVI Regimes)**
   - Surfaces are generated using the Stochastic Volatility Inspired (SVI) parameterization, a standard in equity and rates markets.
   - Each regime corresponds to a distinct, economically interpretable SVI parameter schedule (e.g., carry/calm, crash-risk, event-risk), with maturity-dependent parameters.
   - All surfaces are smooth, arbitrage-free (up to discretization), and differ only by geometry (not by level, noise, or global scaling).

2. **2D Path Construction**
   - For each surface and each moneyness slice, construct a 2D path: `γ(s) = (log(maturity), IV)`.
   - This encodes the smile geometry as a path in `R^2`.

3. **Chen–Lyons Path Signature Encoding**
    - For each 2D path, compute the truncated signature `S^{(d)}(γ)` up to depth `d` using the `signatory` library.
    - The signature is a collection of iterated integrals:

       S^{(d)}(γ) = (1, ∫ dγ, ∫ dγ ⊗ dγ, ..., ∫ ... ∫ dγ)

       (All integrals are over increasing time indices; see references for rigorous definition.)
    - For `d=3`, the signature captures all polynomial features up to cubic order, encoding the path's geometry in a coordinate-invariant way.
    - The embedding for each surface is the concatenation of signatures for all moneyness slices.

4. **Embedding Normalization**
   - All signature embeddings are standardized (zero mean, unit variance) for clustering.

5. **Unsupervised Clustering (HDBSCAN)**
   - HDBSCAN is applied to the geometric embeddings, discovering clusters ("geometric regimes") without using time or labels.
   - Membership probabilities quantify cluster confidence.

6. **Cluster-to-Regime Mapping**
   - Clusters are mapped to true regimes by majority vote (for diagnostics only).

7. **Temporal Stickiness Filter**
   - A sliding-window filter enforces regime persistence: a regime change is accepted only if it persists for $W$ steps and the average cluster probability exceeds a threshold.
   - This models realistic regime transitions and suppresses noise.

8. **Visualization and Diagnostics**
   - **Geometry-only UMAP plots:** Embeddings colored by true regime, cluster, and probability (no time semantics).
   - **Temporal diagnostics:** Step plots of true, raw, and sticky regimes; membership probability over time.
   - **Synchronized animation:** 3D IV surface and regime timeline, with a moving cursor.

## Mathematical Details

### SVI Parameterization
Each IV smile is generated by the SVI total variance formula:
w(k) = a + b \left[ \rho (k - m) + \sqrt{(k - m)^2 + \sigma^2} \right]
$$
   w(k) = a + b [ ρ (k - m) + sqrt((k - m)^2 + σ^2) ]

where:
- `k` = log-moneyness
- `a` = ATM total variance
- `b` = slope (controls smile width)
- `ρ` = skewness (controls asymmetry)
- `m` = horizontal shift
- `σ` = curvature (controls smile convexity)

Regimes are defined by maturity-dependent schedules for `(a, b, ρ, m, σ)`, e.g.:
- **Carry:** Flat skew, low curvature
- **Crash:** Strong negative skew, moderate curvature
- **Event:** High ATM convexity, term-structure of skew

### Path Signature
Given a path `γ: [0,1] → R^2`, the signature up to depth `d` is:

   S^{(d)}(γ) = (1, S^1, S^2, ..., S^d)

where `S^k` is the k-fold iterated integral:

   S^k = ∫_{0 < t_1 < ... < t_k < 1} dγ_{t_1} ⊗ ... ⊗ dγ_{t_k}

The signature uniquely encodes the path's geometry up to tree-like equivalence, and is invariant to reparametrization.

### HDBSCAN Clustering
HDBSCAN is a density-based clustering algorithm that finds clusters of varying shape and density in high-dimensional space. It assigns a membership probability to each point, and labels outliers as noise (`-1`).

### Temporal Stickiness Filter
Given a sequence of predicted regimes `r_t` and probabilities `p_t`, the sticky regime `r̂_t` is defined recursively:
- At each `t`, consider the window `[t-W+1, t]`
- If a regime appears in the majority and `mean(p_t)` exceeds a threshold, accept the change
- Otherwise, retain the previous regime

### Evaluation Metrics
- **Adjusted Rand Index (ARI):** Measures clustering similarity, adjusted for chance
- **Normalized Mutual Information (NMI):** Measures mutual information between true and predicted regimes

## Usage
1. Install requirements: `pip install numpy torch signatory matplotlib hdbscan umap-learn scikit-learn pandas`
2. Run the script: `python script.py`
3. Inspect the geometric and temporal diagnostics, and the synchronized animation

## Research Goal
This framework tests whether path signatures and geometry-driven clustering can recover economically meaningful volatility regimes from realistic, market-consistent surfaces, without relying on level, noise, or ad-hoc features. It is a rigorous benchmark for unsupervised regime discovery in quantitative finance.

## References
- Gatheral, J. (2004). "A Parsimonious Arbitrage-Free Implied Volatility Parameterization with Application to the Valuation of Volatility Derivatives" (SVI)
- Chevyrev, I., & Kormilitzin, A. (2016). "A Primer on the Signature Method in Machine Learning"
- Campagna, J., et al. (2020). "Signature Methods in Machine Learning for Finance"
- McInnes, L., Healy, J., & Astels, S. (2017). "hdbscan: Hierarchical density based clustering"
